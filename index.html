<!DOCTYPE html>

<html lang="en">
<meta name="viewport" content="width=device-width, initial-scale=1">
<head>


<link rel="stylesheet" href="https://cdn.jsdelivr.net/leaflet/1.0.0-beta.2/leaflet.css" />
  <script src="https://cdn.jsdelivr.net/leaflet/1.0.0-beta.2/leaflet.js"></script>

<script src="js/jquery.js"></script>
<script type="text/javascript" src="http://maps.stamen.com/js/tile.stamen.js?v1.3.0"></script>
<script src="APVouchers.js"></script>
<script src="https://cdn.jsdelivr.net/leaflet.esri/2.0.0-beta.8/esri-leaflet.js"></script>

<link href="css/bootstrap.min.css" rel="stylesheet">
</head>
<style>
#mapid {height:680px;}

#mapid{
	background-color:lightblue;
	-moz-box-shadow:    3px 3px 5px 3px #ccc;
  -webkit-box-shadow: 3px 3px 5px 3px #ccc;
  box-shadow:         3px 3px 5px 3px #ccc;
-moz-border-radius: 10px;
-webkit-border-radius: 10px;
border-radius: 10px; /* future proofing */
-khtml-border-radius: 10px; /* for old Konqueror browsers */

}
.label {color:blue;font-weight: bold; display:none;}
.navbar-inverse{
	background-color: #333333;
}
</style>
<body>
<div class="navbar navbar-inverse navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
        <div class="row">
       		<div class='col-md-5'><h4 style='color:yellow'>Alternative Payment Vouchers</h4></div>
        	<div class='col-md-3'><h4 style='color:WHITE' id="lblAgency"></h4></div>
			<div class='col-md-3'><h4 style='color:WHITE' id="lblType"></h4></div>
        </div>
        </div>
      </div>
    </div>

<div class="container-fluid" style="margin-top:100px">
	
	<div id='sideBar' class='col-md-3'>
	<div>

  <!-- Nav tabs -->
  <ul class="nav nav-tabs" role="tablist">
    <li role="presentation" class="active"><a href="#home" aria-controls="home" role="tab" data-toggle="tab">HOME</a></li>
    <li role="presentation" class="sites"><a href="#profile" aria-controls="profile" role="tab" data-toggle="tab">SITES</a></li>
    <li role="presentation" class="kids"><a href="#messages" aria-controls="messages" role="tab" data-toggle="tab">KIDS</a></li>
    <li role="presentation" class="kids"><a href="#layers" aria-controls="layers" role="tab" data-toggle="tab">LAYERS</a></li>
   
  </ul>

  <!-- Tab panes -->
  <div class="tab-content">
    <div role="tabpanel" class="tab-pane active" id="home">
    <h3>AP Voucher Map</h3>
    This is where you can explore the locations of AP Voucher usage both by number of providers and number of children served.
    <hr />
    <h5><strong>STEP 1:</strong> SELECT AGENCY</h5>
		<ul class="nav" id='agency'>
              <li class="active"><a data-match= 'AP_ALL' href="#">ALL AGENCIES</a></li>
			  <li><a data-match= 'AP_BAN' href="#">BANANAS</a></li>
              <li><a data-match= 'AP_CHILD' href="#about">CHILD CARE LINKS</a></li>
              <li><a data-match= 'AP_CFCR' href="#contact">CHILDREN AND FAMILY RESOURCE CENTER</a></li>
              <li><a data-match= 'AP_DAVIS' href="#contact">DAVIS STREET</a></li>
              <li><a data-match= 'AP_C4' href="#contact">4C OF ALAMEDA COUNTY</a></li>
			
            </ul>
            <hr />
    
    
    </div>
		
		
    <div role="tabpanel" class="tab-pane" id="profile">
    	<h5 id="lblAgency"></h5>
		<h5 id="lblType"></h5>
		<h5 style="margin-top:30px"><strong>STEP 2:</strong> SELECT TO VIEW PROVIDERS OR CHILDREN</h5>

		<hr />
		
		<h5>HOW MANY PROVIDER SITES FOR THAT AGENCY</h5>	
            <ul class="nav" id='siteType'>
              <li class="active"><a data-match='TRACT' href="#">ALL SITES</a></li>
			  <li><a data-match= 'FFN' href="#">FRIENDS AND FAMILY</a></li>
              <li><a data-match= 'FCC' href="#about">FAMILY CHILD CARE</a></li>
              <li><a data-match= 'CTR' href="#contact">CHILD CARE CENTERS</a></li>
			
            </ul>
           <hr />
        <h5>HOW MANY CHILDREN FOR THAT AGENCY</h5>	
            <ul class="nav" id='siteType'>
              <li class="active"><a data-match= 'KID' href="#">ALL AGES</a></li>
			  <li><a data-match= 'INF' href="#">INFANT</a></li>
              <li><a data-match= 'TOT' href="#about">TODDLER</a></li>
              <li><a data-match= 'PRE' href="#contact">PRESCHOOL</a></li>
			
            </ul>
         
	</div>
		
    <div role="tabpanel" class="tab-pane" id="messages">
    	
    	<div>
    		<H3 id='tractSelected'></H3>
    		<table id='tractData' class='table table-striped'>
    		<thead>
    		<th>Category</th>
    		<th>Selected Agency</th>
    		<th>All Agencies</th>
    		</thead>
    		</table>

    	</div>

    </div>
    
    <div role="tabpanel" class="tab-pane" id="layers">
   	 <h3>Add layers to the map</h3>
   	 Check the following options to add to the map
    <hr />	
   	<div class="radio">
  <label>
    <input type="radio" name="optionsRadios" id="optionsRadios1" value="city" checked>
   Add city and place limits to the map
  </label>
</div>
<div class="radio">
  <label>
    <input type="radio" name="optionsRadios" id="optionsRadios2" value="zip">
    Add zip code boundaries to the map
  </label>
</div>
<div class="radio disabled">
  <label>
    <input type="radio" name="optionsRadios" id="optionsRadios3" value="center" disabled>
    Add all licensed child care centers to the map
  </label>
</div>
<hr />
           
    
    
    </div>
  </div>

</div>
</div>
<div id='mapid' class='col-md-8'></div>

</div>

<script type="text/javascript">
$('#myTabs a').click(function (e) {
  e.preventDefault()
  $(this).tab('show')
})
//create event for option box
var theType = 'APALL';
var theAgency = 'sites'
var selectedProperty;
	
var map = L.map("mapid").setView([37.61912, -121.93285], 10);

var tiles = L.esri.basemapLayer("Gray").addTo(map);

map.on("zoomend",checkZoom)



//ADD OVERLAYS

var cityGEO = $.getJSON("places.geojson",function(data){
	L.geoJson(data,{style:cityStyle,
		onEachFeature:function(feature,layer){
			layer.bindPopup(feature.properties.NAMELSAD);
		}}).addTo(overlayMaps)
});


var cartoSites = L.layerGroup().addTo(map);

//var apGEO = $.getJSON("http://ploebus.cartodb.com/api/v1/sql?q="+sql+"&format=geojson&callback=?",function(data){
//	L.geoJson(data,{style:cityStyle}).addTo(cartoSites)
//});

var zipGEO = $.getJSON("zip.geojson",function(data){
	L.geoJson(data,{style:cityStyle,
		onEachFeature:function(feature,layer){
			layer.bindPopup("Zip Code: " + feature.properties.postalcode);
		}}).addTo(overlayMaps1)
});







var cityStyle =
	{fillOpacity:0,
		weight:1,
		color:'#333333'}

var myStyle = {
	color:'#333333',
	weight:.2,
	dashArray:3,
	fillColor:'white',
	opacity:.3

}


var siteLayer =	L.geoJson(tracts,
	{style:function(feature){
		switch(feature.properties.APALL_sites){
			case 0: return{color:"#000000",weight:.5};
			default: return myStyle;

			}
		},
		onEachFeature:function(feature,layer){
			layer.bindPopup("TRACT: " + feature.properties.TRACTCE)
			
		}})



//layer groups
var theSites = L.layerGroup([siteLayer]).addTo(map);

var overlayMaps = L.layerGroup();


var overlayMaps1 = L.layerGroup();


var baseMaps = {
	"grey": tiles
};

var layerSwitcher = {
	"Cities": overlayMaps,
	"Zips":overlayMaps1
};

L.control.layers(baseMaps,layerSwitcher).addTo(map)
//zipGeo.addTo(map);
//HELPERS
function addTopTen(type){
	cartoSites.clearLayers();
	sql = encodeURIComponent("SELECT " + type + ",the_geom,row_number() OVER(ORDER BY  " + type + " DESC) AS position FROM apvouchers order by  " + type + " desc limit 5");
	
	$.getJSON("http://ploebus.cartodb.com/api/v1/sql?q="+sql+"&format=geojson&callback=?", function(data){
	L.geoJson(data).addTo(cartoSites);
	});
}

function checkZoom(){
	if(map.getZoom()> 11){
		$(".label").show();
	}
	else{
		$(".label").hide();
	}
}

function getColor(d) {
    return d > 5 ? '#7f2704' :
           d > 3  ? '#fd9243' :
           d > 1  ? '#fff5eb' :
                     '#FFFFFF';
}

function getOpacity(d){
	return d > 0 ? .7:
				0;
}

function style(feature) {
    return {
        fillColor: getColor(feature.properties[selectedProperty]),
        weight: .5,
        opacity: 1,
        color: '#333333',
        dashArray: '3',
        fillOpacity: getOpacity(feature.properties[selectedProperty])
    };
}

function updateMap(){
	theSites.clearLayers()
	var labelMarkers = []
	//change siteLayer
	selectedProperty = theAgency + '_' + theType
	console.log(selectedProperty.toLowerCase())
	addTopTen(selectedProperty.toLowerCase());
	var siteLayer =	L.geoJson(tracts,{
		style:style,
		onEachFeature:function(feature, layer){
			 layer.bindPopup(feature.properties.TRACTCE);
			 layer.on('click',doThis)
			 try{
			 	
			 	if(feature.properties[theAgency + '_' + theType] > 0){
			 	label = L.marker(layer.getBounds().getCenter(), {
			 	icon:L.divIcon({
			 		className:'label',
			 		html:"<h5>" + feature.properties[theAgency + '_' + theType] + "</h5>",
			 		iconSize:[100, 40]


			 	})
			 	
			 	})
			 	theSites.addLayer(label)
			 }}
			 catch(e){
			 	console.log("So what")
			 }
		//add click event
		

		}
		
	})

	theSites.addLayer(siteLayer);
	checkZoom();
}

function doThis(e){
	
	getTractData(e.target.feature.properties['TRACTCE']);

}

function getTractData(t){

	for(var i = 0; i<361 ; i++){
		if(tracts.features[i].properties['TRACTCE'] == t){
			totalProviders = tracts.features[i].properties[theAgency +'_CTR'] + tracts.features[i].properties[theAgency +'_FCC'] + tracts.features[i].properties[theAgency +'_FFN'];
			$('#tractSelected').text(tracts.features[i].properties['NAMELSAD']);
			$("#tractData").find("tr:gt(0)").remove()
			$("#tractData").append("<tr class='info'><td>Providers:</td><td>" + totalProviders + "</td><td>" + tracts.features[i].properties['AP_ALL_TRACT'] + "</td></tr>")
			$("#tractData").append("<tr><td>Child Care Centers:</td><td>" + tracts.features[i].properties[theAgency +'_CTR'] + "</td><td>" + tracts.features[i].properties['AP_ALL_CTR'] + "</td></tr>")
			$("#tractData").append("<tr><td>Family Child Care:</td><td>" + tracts.features[i].properties[theAgency +'_FCC'] + "</td><td>" + tracts.features[i].properties['AP_ALL_FCC'] + "</td></tr>")
			$("#tractData").append("<tr><td>Friends and Family:</td><td>" + tracts.features[i].properties[theAgency +'_FFN'] + "</td><td>" + tracts.features[i].properties['AP_ALL_FFN'] + "</td></tr>")
			$("#tractData").append("<tr class='info'><td>Children Served:</td><td>" + tracts.features[i].properties[theAgency +'_KID'] + "</td><td>" + tracts.features[i].properties['AP_ALL_KID'] + "</td></tr>")
			$("#tractData").append("<tr><td>Infants:</td><td>" + tracts.features[i].properties[theAgency +'_INF'] + "</td><td>" + tracts.features[i].properties['AP_ALL_INF'] + "</td></tr>")
			$("#tractData").append("<tr><td>Toddlers:</td><td>" + tracts.features[i].properties[theAgency +'_TOT'] + "</td><td>" + tracts.features[i].properties['AP_ALL_TOT'] + "</td></tr>")
			$("#tractData").append("<tr><td>Preschoolers:</td><td>" + tracts.features[i].properties[theAgency +'_PRE'] + "</td><td>" + tracts.features[i].properties['AP_ALL_PRE'] + "</td></tr>")
		}
	}

}

//change things on user select
$("#siteType a").click(function(a){
	theType = $(this).attr('data-match');
	console.log(theType)
	updateMap()
	$("#lblType").text("TYPE: " + $(this).text())
	//remove layer
})

$("#agency a").click(function(a){
	theAgency = $(this).attr('data-match');
	console.log(theAgency)
	$(".sites a").tab('show');
	updateMap()
	$("#lblAgency").text("AGENCY: " + $(this).text())
	//remove layer
})
	



</script>
<script src="js/jquery.js"></script>
<script src="js/bootstrap.min.js"></script>
</body>
</html>